import{p as U,q,r as h,j as e,B as a,z as Q,bv as se,bw as ie,T as x,i as ne,P as oe,k as re,l as ae,m as Y,n as S,o as le,v as X,t as G,I as P,aH as de,a8 as ce,bx as ue,aU as J,A as L,D as $,a as R,C as H,a3 as K,V as xe,by as he,f as me,$ as fe}from"./ui-CvbxGYbq.js";import{u as B,s as n,C as V,c as s,b as E,f as ge,t as i,a as M,d as be,P as O}from"./index-w50UBTMh.js";import{u as c,R as ye,C as pe,l as _,a as Z,I as ee,F as te}from"./FileUploadSection-BUjPYNB3.js";import"./firebase-CTJJwFJC.js";import"./vendor-BFl3bqVE.js";import"./purify.es-CQJ0hv7W.js";const je=()=>{const o=U(),f=q(o.breakpoints.down("md")),{userDetails:p}=B(),[b,k]=h.useState(""),C=c(r=>r.filters.searchQuery),z=c(r=>r.setSearchQuery),u=c(r=>r.filters.courseId),v=c(r=>r.setSelectedCourse);c(r=>r.viewMode),c(r=>r.setViewMode),c(r=>r.setActivePanel),c(r=>r.fetchAllData),h.useEffect(()=>{k(C)},[]),h.useEffect(()=>{const r=setTimeout(()=>{b!==C&&z(b)},300);return()=>clearTimeout(r)},[b,C,z]);const W=Object.entries((p==null?void 0:p.classes)||{}).map(([r,D])=>({id:r,number:D.number,title:D.title,isCourseAdmin:D.isCourseAdmin}));return e.jsxs(a,{sx:{display:"flex",flexDirection:f?"column":"row",gap:n[3],alignItems:f?"stretch":"center"},children:[e.jsx(a,{sx:{flex:f?"1":"0 0 40%",minWidth:f?"100%":"auto"},children:e.jsx(V,{value:u||"",onChange:r=>v(r||null),courses:[{id:"",number:"All",title:"Designs",isCourseAdmin:!1},...W],size:"medium",showAdminBadge:!1,label:"",placeholder:"Filter by course..."})}),e.jsx(a,{sx:{flex:f?"1":"0 0 60%",minWidth:f?"100%":"auto"},children:e.jsx(Q,{placeholder:"Search designs...",value:b,onChange:r=>k(r.target.value),size:"medium",fullWidth:!0,InputProps:{startAdornment:e.jsx(se,{position:"start",children:e.jsx(ie,{sx:{color:s.text.tertiary}})})},sx:{"& .MuiOutlinedInput-root":{borderRadius:E.lg,backgroundColor:s.background.secondary,"& fieldset":{borderColor:s.neutral[200]},"&:hover fieldset":{borderColor:s.neutral[300]},"&.Mui-focused fieldset":{borderColor:s.primary[500]}}}})})]})},Ce=({designs:o})=>{const f=ge(),p=U(),b=q(p.breakpoints.down("md")),k=c(t=>t.builds),C=c(t=>t.tests),z=c(t=>t.fetchAllData),[u,v]=h.useState({open:!1,designId:null,designTitle:null,buildCount:0,testCount:0}),[W,r]=h.useState(!1),D=t=>{const l=k.filter(A=>A.design_ID===t),j=l.map(A=>A.id),T=C.filter(A=>j.includes(A.build_ID));return{buildCount:l.length,testCount:T.length}},w=t=>{if(!t)return"N/A";let l;t.toDate&&typeof t.toDate=="function"?l=t.toDate():t.seconds?l=new Date(t.seconds*1e3):l=new Date(t);const j=l.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),T=l.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return`${j}, ${T}`},m=t=>{f(`/laboratory-notebook/${t}`)},g=t=>{const l=D(t.id);v({open:!0,designId:t.id,designTitle:t.title,buildCount:l.buildCount,testCount:l.testCount})},F=()=>{v({open:!1,designId:null,designTitle:null,buildCount:0,testCount:0})},I=async()=>{if(u.designId){r(!0);try{const t=o.find(l=>l.id===u.designId);if(!t)return;await _.deleteDesign(u.designId,t.userId),await z(t.userId,!1,[]),F()}catch(t){console.error("Error deleting design:",t),alert("Failed to delete design. Please try again.")}finally{r(!1)}}};return o.length===0?e.jsxs(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:400,p:n[6]},children:[e.jsx(x,{variant:"h5",sx:{fontFamily:i.fontFamily.display,color:s.text.secondary,mb:n[2]},children:"No Designs Yet"}),e.jsx(x,{variant:"body1",sx:{color:s.text.tertiary,textAlign:"center",maxWidth:500},children:"Start by creating your first design to visualize your experimental workflow."})]}):e.jsxs(ne,{component:oe,sx:{borderRadius:E.xl,boxShadow:M.md,border:`1px solid ${s.neutral[200]}`},children:[e.jsxs(re,{children:[e.jsx(ae,{children:e.jsxs(Y,{sx:{backgroundColor:s.background.secondary},children:[e.jsx(S,{sx:{fontFamily:i.fontFamily.secondary,fontWeight:i.fontWeight.bold,color:s.text.primary,fontSize:i.fontSize.sm},children:"Title"}),!b&&e.jsx(S,{sx:{fontFamily:i.fontFamily.secondary,fontWeight:i.fontWeight.bold,color:s.text.primary,fontSize:i.fontSize.sm},children:"Description"}),e.jsx(S,{align:"center",sx:{fontFamily:i.fontFamily.secondary,fontWeight:i.fontWeight.bold,color:s.text.primary,fontSize:i.fontSize.sm},children:"Builds"}),e.jsx(S,{align:"center",sx:{fontFamily:i.fontFamily.secondary,fontWeight:i.fontWeight.bold,color:s.text.primary,fontSize:i.fontSize.sm},children:"Tests"}),!b&&e.jsxs(e.Fragment,{children:[e.jsx(S,{sx:{fontFamily:i.fontFamily.secondary,fontWeight:i.fontWeight.bold,color:s.text.primary,fontSize:i.fontSize.sm},children:"Created"}),e.jsx(S,{sx:{fontFamily:i.fontFamily.secondary,fontWeight:i.fontWeight.bold,color:s.text.primary,fontSize:i.fontSize.sm},children:"Modified"})]}),e.jsx(S,{align:"center",sx:{fontFamily:i.fontFamily.secondary,fontWeight:i.fontWeight.bold,color:s.text.primary,fontSize:i.fontSize.sm},children:"Actions"})]})}),e.jsx(le,{children:o.map(t=>{const l=D(t.id);return e.jsxs(Y,{sx:{"&:hover":{backgroundColor:s.primary[50],cursor:"pointer"},transition:be.transitions.fast},onClick:()=>m(t.id),children:[e.jsx(S,{children:e.jsx(x,{variant:"body1",sx:{fontWeight:i.fontWeight.semibold,color:s.text.primary,fontFamily:i.fontFamily.secondary},children:t.title})}),!b&&e.jsx(S,{children:e.jsx(a,{sx:{maxWidth:400},children:e.jsx(ye,{content:t.description||"<p>No description</p>",maxLines:2})})}),e.jsx(S,{align:"center",children:e.jsx(X,{label:l.buildCount,size:"small",sx:{backgroundColor:l.buildCount>0?s.secondary[100]:s.neutral[100],color:l.buildCount>0?s.secondary[700]:s.text.tertiary,fontWeight:i.fontWeight.bold,minWidth:40}})}),e.jsx(S,{align:"center",children:e.jsx(X,{label:l.testCount,size:"small",sx:{backgroundColor:l.testCount>0?"#FFEDD5":s.neutral[100],color:l.testCount>0?"#C2410C":s.text.tertiary,fontWeight:i.fontWeight.bold,minWidth:40}})}),!b&&e.jsxs(e.Fragment,{children:[e.jsx(S,{children:e.jsx(x,{variant:"body2",sx:{color:s.text.tertiary,fontSize:i.fontSize.sm},children:w(t.dateCreated)})}),e.jsx(S,{children:e.jsx(x,{variant:"body2",sx:{color:s.text.tertiary,fontSize:i.fontSize.sm},children:w(t.dateModified)})})]}),e.jsx(S,{align:"center",children:e.jsxs(a,{sx:{display:"flex",gap:n[1],justifyContent:"center"},children:[e.jsx(G,{title:"View Diagram",children:e.jsx(P,{size:"small",onClick:j=>{j.stopPropagation(),m(t.id)},sx:{color:s.primary[500],"&:hover":{backgroundColor:s.primary[50]}},children:e.jsx(de,{fontSize:"small"})})}),e.jsx(G,{title:"Delete Design",children:e.jsx(P,{size:"small",onClick:j=>{j.stopPropagation(),g(t)},sx:{color:s.error,"&:hover":{backgroundColor:"#FEE2E2"}},children:e.jsx(ce,{fontSize:"small"})})})]})})]},t.id)})})]}),e.jsx(pe,{open:u.open,title:"Delete Design?",message:`Are you sure you want to delete "${u.designTitle}"? ${u.buildCount>0||u.testCount>0?`This will also delete ${u.buildCount} build${u.buildCount!==1?"s":""} and ${u.testCount} test${u.testCount!==1?"s":""}. `:""}This action cannot be undone.`,confirmLabel:W?"Deleting...":"Delete",cancelLabel:"Cancel",onConfirm:I,onCancel:F,isDestructive:!0})]})},Se=()=>{const{userDetails:o}=B(),f=c(d=>d.setActivePanel);c(d=>d.addDesign);const p=c(d=>d.fetchAllData),[b,k]=h.useState(""),[C,z]=h.useState(""),[u,v]=h.useState(""),[W,r]=h.useState([]),[D,w]=h.useState([]),[m,g]=h.useState(!1),[F,I]=h.useState(null),t=c(d=>d.setIsExpanded),l=Object.entries((o==null?void 0:o.classes)||{}).map(([d,y])=>({id:d,number:y.number,title:y.title,isCourseAdmin:y.isCourseAdmin})),j=()=>{f(null)},T=()=>{t(!0)},A=async d=>{if(d.preventDefault(),!b.trim()){I("Title is required");return}if(!C.trim()){I("Description is required");return}if(!u){I("Please select a course");return}if(!o){I("User not authenticated");return}g(!0),I(null);try{const y=await _.createDesign({title:b.trim(),description:C.trim(),course:u,userId:o.uid,images:W,files:D}),N=Object.keys(o.classes||{});await p(o.uid,o.isAdmin,N),f(null)}catch(y){console.error("Error creating design:",y),I(y instanceof Error?y.message:"Failed to create design")}finally{g(!1)}};return e.jsxs(a,{sx:{position:"fixed",right:0,top:0,height:"100vh",width:480,backgroundColor:s.background.primary,boxShadow:M["2xl"],zIndex:1300,display:"flex",flexDirection:"column",animation:"slideInRight 0.3s ease-out","@keyframes slideInRight":{from:{transform:"translateX(100%)"},to:{transform:"translateX(0)"}}},children:[e.jsx(a,{sx:{p:n[4],borderBottom:`1px solid ${s.neutral[200]}`,backgroundColor:s.primary[50]},children:e.jsxs(a,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(x,{variant:"h4",sx:{fontFamily:i.fontFamily.display,fontWeight:i.fontWeight.bold,color:s.text.primary},children:"Create New Design"}),e.jsxs(a,{sx:{display:"flex",gap:n[1]},children:[e.jsx(P,{size:"small",onClick:T,disabled:m,children:e.jsx(ue,{})}),e.jsx(P,{size:"small",onClick:j,disabled:m,children:e.jsx(J,{})})]})]})}),e.jsxs(a,{component:"form",onSubmit:A,sx:{flex:1,overflowY:"auto",p:n[4],display:"flex",flexDirection:"column",gap:n[4]},children:[F&&e.jsx(L,{severity:"error",onClose:()=>I(null),children:F}),e.jsx(a,{children:e.jsx(V,{value:u,onChange:d=>v(d||""),courses:l,disabled:m,size:"medium",showAdminBadge:!1})}),e.jsx(Q,{label:"Title",value:b,onChange:d=>k(d.target.value),required:!0,fullWidth:!0,disabled:m,placeholder:"Enter design title",sx:{"& .MuiOutlinedInput-root":{borderRadius:E.lg}}}),e.jsxs(a,{children:[e.jsx(x,{variant:"body2",sx:{mb:n[1],color:s.text.secondary,fontWeight:i.fontWeight.medium},children:"Description *"}),e.jsx(Z,{value:C,onChange:z,placeholder:"Describe your design, its purpose, and goals...",minHeight:200,disabled:m})]}),e.jsx($,{sx:{my:n[2]}}),e.jsx(ee,{images:W,onImagesChange:r,storagePath:"",disabled:m}),e.jsx($,{sx:{my:n[2]}}),e.jsx(te,{files:D,onFilesChange:w,storagePath:"",disabled:m,maxFileSize:10}),e.jsx(L,{severity:"info",sx:{borderRadius:E.lg},children:e.jsx(x,{variant:"body2",children:"After creating your design, you can add builds and tests to it from the graph view."})})]}),e.jsxs(a,{sx:{p:n[4],borderTop:`1px solid ${s.neutral[200]}`,display:"flex",gap:n[2]},children:[e.jsx(R,{variant:"outlined",onClick:j,fullWidth:!0,disabled:m,children:"Cancel"}),e.jsx(R,{type:"submit",variant:"contained",onClick:A,fullWidth:!0,disabled:m,startIcon:m?e.jsx(H,{size:20}):e.jsx(K,{}),sx:{backgroundColor:s.primary[500],"&:hover":{backgroundColor:s.primary[600]}},children:m?"Creating...":"Create Design"})]})]})},ve=()=>{const{userDetails:o}=B(),f=c(d=>d.setActivePanel),p=c(d=>d.setIsExpanded),b=c(d=>d.fetchAllData),[k,C]=h.useState(""),[z,u]=h.useState(""),[v,W]=h.useState(""),[r,D]=h.useState([]),[w,m]=h.useState([]),[g,F]=h.useState(!1),[I,t]=h.useState(null),l=Object.entries((o==null?void 0:o.classes)||{}).map(([d,y])=>({id:d,number:y.number,title:y.title,isCourseAdmin:y.isCourseAdmin})),j=()=>{p(!1)},T=()=>{p(!1),f(null)},A=async d=>{if(d.preventDefault(),!k.trim()){t("Title is required");return}if(!z.trim()){t("Description is required");return}if(!v){t("Please select a course");return}if(!o){t("User not authenticated");return}F(!0),t(null);try{const y=await _.createDesign({title:k.trim(),description:z.trim(),course:v,userId:o.uid,images:r,files:w}),N=Object.keys(o.classes||{});await b(o.uid,o.isAdmin,N),p(!1),f(null)}catch(y){console.error("Error creating design:",y),t(y instanceof Error?y.message:"Failed to create design")}finally{F(!1)}};return e.jsxs(xe,{open:!0,onClose:T,fullScreen:!0,sx:{"& .MuiDialog-paper":{backgroundColor:s.background.primary}},children:[e.jsx(a,{sx:{position:"sticky",top:0,zIndex:1100,p:n[4],borderBottom:`1px solid ${s.neutral[200]}`,backgroundColor:s.primary[50]},children:e.jsx(a,{sx:{maxWidth:1200,mx:"auto",width:"100%"},children:e.jsxs(a,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:n[2]},children:[e.jsx(P,{size:"small",onClick:j,disabled:g,children:e.jsx(he,{})}),e.jsx(x,{variant:"h3",sx:{fontFamily:i.fontFamily.display,fontWeight:i.fontWeight.bold,color:s.text.primary},children:"Create New Design"})]}),e.jsx(P,{size:"small",onClick:T,disabled:g,children:e.jsx(J,{})})]})})}),e.jsx(a,{component:"form",onSubmit:A,sx:{flex:1,overflowY:"auto",p:n[6]},children:e.jsxs(a,{sx:{maxWidth:1200,mx:"auto",width:"100%",display:"flex",flexDirection:"column",gap:n[4]},children:[I&&e.jsx(L,{severity:"error",onClose:()=>t(null),children:I}),e.jsx(Q,{label:"Title",value:k,onChange:d=>C(d.target.value),required:!0,fullWidth:!0,disabled:g,placeholder:"Enter design title",sx:{"& .MuiOutlinedInput-root":{borderRadius:E.lg,fontSize:i.fontSize.xl}}}),e.jsxs(a,{children:[e.jsx(x,{variant:"body1",sx:{mb:n[2],color:s.text.secondary,fontWeight:i.fontWeight.medium,fontSize:i.fontSize.lg},children:"Description *"}),e.jsx(Z,{value:z,onChange:u,placeholder:"Describe your design, its purpose, and goals...",minHeight:400,disabled:g})]}),e.jsxs(a,{children:[e.jsx(x,{variant:"body1",sx:{mb:n[2],color:s.text.secondary,fontWeight:i.fontWeight.medium,fontSize:i.fontSize.lg},children:"Course *"}),e.jsx(V,{value:v,onChange:d=>W(d||""),courses:l,disabled:g,size:"medium",showAdminBadge:!1})]}),e.jsx($,{sx:{my:n[3]}}),e.jsx(ee,{images:r,onImagesChange:D,storagePath:"",disabled:g}),e.jsx($,{sx:{my:n[3]}}),e.jsx(te,{files:w,onFilesChange:m,storagePath:"",disabled:g,maxFileSize:10}),e.jsx(L,{severity:"info",sx:{borderRadius:E.lg},children:e.jsx(x,{variant:"body2",children:"After creating your design, you can add builds and tests to it from the graph view."})})]})}),e.jsx(a,{sx:{position:"sticky",bottom:0,p:n[4],backgroundColor:s.background.primary,borderTop:`1px solid ${s.neutral[200]}`,boxShadow:"0 -4px 6px -1px rgba(0, 0, 0, 0.1)"},children:e.jsxs(a,{sx:{maxWidth:1200,mx:"auto",width:"100%",display:"flex",gap:n[2]},children:[e.jsx(R,{variant:"outlined",onClick:j,fullWidth:!0,size:"large",disabled:g,children:"Cancel"}),e.jsx(R,{type:"submit",variant:"contained",onClick:A,fullWidth:!0,size:"large",disabled:g,startIcon:g?e.jsx(H,{size:20}):e.jsx(K,{}),sx:{backgroundColor:s.primary[500],"&:hover":{backgroundColor:s.primary[600]}},children:g?"Creating...":"Create Design"})]})})]})},Fe=()=>{const{userDetails:o,loading:f}=B(),[p,b]=h.useState(!1),k=U(),C=q(k.breakpoints.down("md")),z=c(t=>t.isLoading),u=c(t=>t.error),v=c(t=>t.fetchAllData),W=c(t=>t.designs),r=c(t=>t.activePanel),D=c(t=>t.isExpanded),w=c(t=>t.filters.searchQuery),m=c(t=>t.filters.courseId),g=c(t=>t.setActivePanel),F=me.useMemo(()=>{let t=W;if(m&&(t=t.filter(l=>l.course===m)),w){const l=w.toLowerCase();t=t.filter(j=>j.title.toLowerCase().includes(l)||j.description.toLowerCase().includes(l))}return t},[W,w,m]);if(h.useEffect(()=>{if(!f&&o&&!p){const t=Object.keys(o.classes||{});v(o.uid,o.isAdmin,t),b(!0)}},[o,f,v,p]),f||z&&!p)return e.jsxs(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"80vh",gap:n[4]},children:[e.jsx(H,{size:60,sx:{color:s.primary[500]}}),e.jsx(x,{variant:"h6",sx:{fontFamily:i.fontFamily.display,color:s.text.secondary},children:"Loading your laboratory notebook..."})]});if(u){const t=u.includes("permission")||u.includes("rules");return e.jsxs(a,{sx:{p:n[6]},children:[e.jsx(O,{title:"Laboratory Notebook",subtitle:"Visualize and manage your experimental designs"}),e.jsxs(L,{severity:"error",sx:{mt:n[4],borderRadius:"12px"},children:[e.jsx(x,{variant:"h6",sx:{mb:1},children:"Error Loading Data"}),e.jsx(x,{variant:"body2",sx:{mb:t?2:0},children:u}),t&&e.jsxs(a,{sx:{mt:2},children:[e.jsx(x,{variant:"body2",sx:{fontWeight:600,mb:1},children:"To fix this issue:"}),e.jsxs(x,{variant:"body2",component:"ul",sx:{pl:2,mb:0},children:[e.jsxs("li",{children:["Deploy Firebase security rules using: ",e.jsx("code",{children:"firebase deploy --only firestore:rules"})]}),e.jsx("li",{children:"Or manually update rules in Firebase Console"}),e.jsxs("li",{children:["See ",e.jsx("code",{children:"docs/FIREBASE_RULES_SETUP.md"})," for detailed instructions"]})]})]})]})]})}return o&&(o.isAdmin||o.isSuperAdmin||o.classes&&Object.keys(o.classes).length>0)?e.jsxs(a,{sx:{p:C?n[3]:n[6],minHeight:"100%"},children:[e.jsx(O,{title:"Laboratory Notebook",subtitle:"Manage your experimental designs, builds, and tests"}),e.jsx(a,{sx:{mb:n[6]},children:e.jsx(je,{})}),p&&e.jsxs(e.Fragment,{children:[e.jsx(a,{sx:{display:"flex",gap:n[4],mb:n[4],flexWrap:"wrap",alignItems:"center"},children:e.jsxs(a,{sx:{flex:1,minWidth:200,p:n[4],backgroundColor:s.primary[50],borderRadius:E.xl,border:`1px solid ${s.primary[200]}`,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(R,{variant:"contained",startIcon:e.jsx(fe,{}),onClick:()=>g("create"),sx:{backgroundColor:s.primary[500],color:s.text.inverse,fontFamily:i.fontFamily.secondary,fontWeight:i.fontWeight.semibold,fontSize:i.fontSize.base,padding:`${n[2]} ${n[4]}`,borderRadius:E.lg,textTransform:"none",boxShadow:M.sm,"&:hover":{backgroundColor:s.primary[600],boxShadow:M.md}},children:C?"New":"New Design"}),e.jsxs(a,{sx:{textAlign:"right"},children:[e.jsx(x,{variant:"h3",sx:{fontFamily:i.fontFamily.display,fontWeight:i.fontWeight.bold,color:s.primary[700],mb:n[1]},children:F.length}),e.jsx(x,{variant:"body2",sx:{color:s.text.secondary,fontWeight:i.fontWeight.medium},children:"Total Designs"})]})]})}),e.jsx(Ce,{designs:F})]}),r==="create"&&(D?e.jsx(ve,{}):e.jsx(Se,{}))]}):e.jsxs(a,{sx:{p:n[6]},children:[e.jsx(O,{title:"Laboratory Notebook",subtitle:"Visualize and manage your experimental designs"}),e.jsxs(L,{severity:"info",sx:{mt:n[4],borderRadius:"12px"},children:[e.jsx(x,{variant:"h6",sx:{mb:1},children:"Course Enrollment Required"}),e.jsx(x,{variant:"body2",children:"The Laboratory Notebook is accessible to users enrolled in an academic course. Please enroll in a course via 'My Account' by following the instructions provided by your academic instructor."})]})]})};export{Fe as default};
